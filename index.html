<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Differentiation Learning Tool — Fully Improved</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
body {font-family: Arial; margin:0; background:#f4f4f4;}
header {background:#0077cc;color:white;padding:20px;text-align:center;}
.container {width:90%;max-width:900px;margin:20px auto;background:white;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);} 
input, button, select {padding:6px;width:100%;margin-top:5px;font-size:14px;} 
button {background:#28a745;color:white;border:none;cursor:pointer;border-radius:5px;}
button:hover {background:#218838;}
.rule {background:#eef5ff;padding:10px;border-left:5px solid #0077cc;margin-bottom:20px;} 
.steps {background:#fff8e1;padding:10px;border-left:5px solid #ff9800;margin-top:10px;white-space:pre-wrap;font-family:Consolas,monospace;} 
.keyboard {background:#eee;padding:4px;margin-top:3px;border-radius:5px;display:grid;grid-template-columns:repeat(5, 1fr);gap:2px;}
.keyboard button {margin:0;padding:4px;font-size:12px;cursor:pointer;background:#fff; border:1px solid #ccc; border-radius:3px;}
</style>
</head>
<body>
<header>
<h1>Differentiation Learning Tool — Fully Improved</h1>
<p>Superscripts + step-by-step working + rule inputs</p>
</header>

<div class="container">
<h2>General Differentiation</h2>
<input id="generalInput" placeholder="e.g., 3x²+3x⁵"/>
<div id="keyboard-general" class="keyboard"></div>
<button onclick="differentiateGeneral()">Differentiate</button>
<div id="generalSteps" class="steps"></div>
</div>

<div class="container rule">
<h3>1. Sum Rule</h3>
<input id="sumInput" placeholder="e.g., 3x² + 3x⁵"/>
<div id="keyboard-sum" class="keyboard"></div>
<button onclick="sumRule()">Apply Sum Rule</button>
<div id="sumSteps" class="steps"></div>
</div>

<div class="container rule">
<h3>2. Product Rule</h3>
<input id="productInput" placeholder="e.g., (x²)(x+1)"/>
<div id="keyboard-product" class="keyboard"></div>
<button onclick="productRule()">Apply Product Rule</button>
<div id="productSteps" class="steps"></div>
</div>

<div class="container rule">
<h3>3. Quotient Rule</h3>
<input id="quotientInput" placeholder="e.g., x²/(x+1)"/>
<div id="keyboard-quotient" class="keyboard"></div>
<button onclick="quotientRule()">Apply Quotient Rule</button>
<div id="quotientSteps" class="steps"></div>
</div>

<div class="container rule">
<h3>4. Chain Rule</h3>
<input id="chainInput" placeholder="e.g., (3x+1)⁵"/>
<div id="keyboard-chain" class="keyboard"></div>
<button onclick="chainRule()">Apply Chain Rule</button>
<div id="chainSteps" class="steps"></div>
</div>

<div class="container rule">
<h3>5. Power Rule</h3>
<input id="powerInput" placeholder="e.g., x⁷"/>
<div id="keyboard-power" class="keyboard"></div>
<button onclick="powerRule()">Apply Power Rule</button>
<div id="powerSteps" class="steps"></div>
</div>

<div class="container rule">
<h3>6. n-th Derivative</h3>
<input id="nthInput" placeholder="e.g., x³ + x"/>
<select id="nthSelect"><option value="2">2nd</option><option value="3">3rd</option><option value="4">4th</option><option value="5">5th</option></select>
<div id="keyboard-nth" class="keyboard"></div>
<button onclick="nthDiff()">Compute n-th Derivative</button>
<div id="nthSteps" class="steps"></div>
</div>

<script>
const supMap={'0':'⁰','1':'¹','2':'²','3':'³','4':'⁴','5':'⁵','6':'⁶','7':'⁷','8':'⁸','9':'⁹'};
const revMap=Object.fromEntries(Object.entries(supMap).map(([k,v])=>[v,k]));

function toNormal(str){
  return str.replace(/[⁰¹²³⁴⁵⁶⁷⁸⁹]+/g, m=>'^'+m.split('').map(ch=>revMap[ch]).join(''))
            .replace(/×/g,'*').replace(/÷/g,'/').replace(/−/g,'-');
}

function toSuper(str){
  return String(str).replace(/\^([0-9]+)/g,(m,p)=>p.split('').map(d=>supMap[d]||d).join(''));
}

function cleanInput(str){return toNormal(str);}

function simplifyPretty(expr){
  try{
    let s = math.simplify(expr).toString();
    s = math.expand(s).toString();
    s = s.replace(/\*/g,'');
    s = toSuper(s);
    return s;
  }catch(e){return toSuper(String(expr).replace(/\*/g,''));}
}

const keys=['¹','²','³','⁴','⁵','⁶','⁷','⁸','⁹','0','1','2','3','4','5','6','7','8','9','(',')','+','-','×','÷','x'];
function setupKeyboard(inputId,kbId){
 const input=document.getElementById(inputId);
 const kb=document.getElementById(kbId);
 kb.innerHTML='';
 keys.forEach(k=>{
  const b=document.createElement('button');
  b.innerText=k;
  b.onclick=()=>{
   const start=input.selectionStart,end=input.selectionEnd,val=input.value;
   input.value=val.slice(0,start)+k+val.slice(end);
   input.selectionStart=input.selectionEnd=start+k.length;
   input.focus();
  };
  kb.appendChild(b);
 });
}

['generalInput','sumInput','productInput','quotientInput','chainInput','powerInput','nthInput'].forEach(id=>{
  const kbId='keyboard-'+id.split('Input')[0];
  const el=document.getElementById(kbId);
  if(el) setupKeyboard(id,kbId);
});

function derivativeStr(expr){return math.derivative(cleanInput(expr),'x').toString();}

function differentiateGeneral(){
  const eq=document.getElementById('generalInput').value;
  const d=simplifyPretty(derivativeStr(eq));
  document.getElementById('generalSteps').innerHTML=`y = ${eq}<br>y' = ${d}`;
}

function sumRule(){
  const eq=document.getElementById('sumInput').value;
  const parts=eq.split('+');
  if(parts.length<2){document.getElementById('sumSteps').innerText='Use + between two terms'; return;}
  const f=parts[0].trim();
  const g=parts.slice(1).join('+').trim();
  const f1=simplifyPretty(derivativeStr(f));
  const g1=simplifyPretty(derivativeStr(g));
  document.getElementById('sumSteps').innerHTML=`y = ${f} + ${g}<br>y' = ${f1} + ${g1}`;
}

function productRule(){
  const raw=document.getElementById('productInput').value.replace(/\s/g,'');
  const m=raw.match(/\((.+)\)\((.+)\)/);
  if(!m){document.getElementById('productSteps').innerText='Use format (f)(g)'; return;}
  const f=m[1], g=m[2];
  let deriv = `(${derivativeStr(f)})*(${g}) + (${f})*(${derivativeStr(g)})`;
  try{deriv = math.expand(deriv).toString();}catch(e){}
  deriv = deriv.replace(/\*/g,'');
  deriv = toSuper(deriv);
  document.getElementById('productSteps').innerHTML=`y = ${f}(${g})<br>y' = ${deriv}`;
}

function quotientRule(){
  const raw=document.getElementById('quotientInput').value.replace(/\s/g,'');
  const parts=raw.split('/');
  if(parts.length!==2){document.getElementById('quotientSteps').innerText='Use format f/g'; return;}
  const f=parts[0], g=parts[1];
  let num, den;
  try{num=math.simplify(math.expand(`(${derivativeStr(f)})*(${g}) - (${f})*(${derivativeStr(g)})`)).toString();}catch(e){num=`(${derivativeStr(f)})*(${g}) - (${f})*(${derivativeStr(g)})`;}
  try{den=math.simplify(`(${g})^2`).toString();}catch(e){den=`(${g})^2`;}
  num=toSuper(num.replace(/\*/g,'')); den=toSuper(den.replace(/\*/g,''));
  document.getElementById('quotientSteps').innerHTML=`y = ${f} / ${g}<br>y' = \\(${num} \\over ${den}\\)`;
  MathJax.typeset();
}

function chainRule(){
  const eq=document.getElementById('chainInput').value;
  const d=simplifyPretty(derivativeStr(eq));
  document.getElementById('chainSteps').innerHTML=`y = ${eq}<br>y' = ${d}`;
}

function powerRule(){
  const eq=document.getElementById('powerInput').value;
  const d=simplifyPretty(derivativeStr(eq));
  document.getElementById('powerSteps').innerHTML=`y = ${eq}<br>y' = ${d}`;
}

function nthDiff(){
  const eq=document.getElementById('nthInput').value;
  const n=parseInt(document.getElementById('nthSelect').value||'2',10);
  if(!eq){document.getElementById('nthSteps').innerText='Enter expression first'; return;}
  let cur=toNormal(eq);
  try{for(let i=0;i<n;i++) cur=math.derivative(cur,'x').toString();}
  catch(e){document.getElementById('nthSteps').innerText='Error computing derivative'; return;}
  const pretty=simplifyPretty(cur);
  document.getElementById('nthSteps').innerHTML=`${n}-th derivative:<br>${pretty}`;
}
</script>
</body>
</html>
